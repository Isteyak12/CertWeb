<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ðŸ“§Certifying!</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      flex-direction: column;
      background-color: #f0f0f0;
    }

    .hidden {
      display: none;
    }

    .button-container {
      text-align: center;
    }

    .button {
      padding: 10px 20px;
      background-color: #4caf50;
      color: white;
      border: none;
      cursor: pointer;
      font-size: 16px;
      margin: 10px;
    }

    .button:hover {
      background-color: #45a049;
    }

    .input-container {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    .box {
      width: 200px;
      height: 100px;
      margin: 10px;
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: lightcoral;
      border: 1px solid red;
      text-align: center;
      position: relative;
      /* Ensure positioning within the container */
    }

    .box input {
      position: absolute;
      bottom: 5px;
      left: 5px;
      width: calc(100% - 10px);
      padding: 5px;
      box-sizing: border-box;
    }

    button {
      padding: 10px 20px;
      background-color: #4caf50;
      color: white;
      border: none;
      cursor: pointer;
      font-size: 16px;
      margin-top: 20px;
    }

    button:hover {
      background-color: #45a049;
    }

    .error-message {
      color: red;
      margin-top: 5px;
      font-size: 14px;
    }

    .pdf-container {
      width: 100%;
      height: 600px;
      margin-top: 20px;
    }

    iframe {
      width: 100%;
      height: 100%;
      border: none;
    }
  </style>
</head>

<body>
  <div class="input-container">
    <div class="box" id="box1">
      Name
      <input type="text" id="name" placeholder="Enter your name" required>
      <div id="name-error" class="error-message"></div>
    </div>
    <div class="box" id="box2">
      Date
      <input type="date" id="dob">
    </div>
    <div class="box" id="box3">
      License Plate Number
      <input type="text" id="license" placeholder="Enter driver's license">
    </div>
    <div class="box" id="box4">
      Email
      <input type="email" id="email" placeholder="Enter your email" required>
      <div id="email-error" class="error-message"></div>
    </div>
    <div class="box" id="box5">
      Car Model
      <input type="text" id="car-model" placeholder="Enter car model" required>
      <div id="car-model-error" class="error-message"></div>
    </div>

    <div class="box" id="box6">
      Price
      <input type="text" id="price" placeholder="Enter price" required>
      <div id="price-error" class="error-message"></div>
    </div>

    <div class="box" id="box7">
      Insurance Date
      <input type="date" id="insurance-date">
    </div>

  </div>

  <!-- <button id="save-btn">SAVE!</button> -->
  <!-- <button id="generate-pdf">Generate PDF</button> -->
  <button id="email-pdf">E-MAIL!</button>

  <div class="pdf-container hidden" id="pdf-container">
    <iframe id="pdf-viewer"></iframe>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
  <script>
    document.getElementById("email-pdf").addEventListener("click", () => {
      generatePDF();
      emailPDF();
    });

    async function emailPDF() {
      const email = document.getElementById("email").value;

      try {
        const response = await fetch("/execute-email", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ email })
        });

        const data = await response.text();
        alert(data);
      } catch (error) {
        console.error("Error:", error);
      }
    }

    async function generatePDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      const name = document.getElementById("name").value;
      const dob = document.getElementById("dob").value;
      const license = document.getElementById("license").value;
      const email = document.getElementById("email").value;
      const insuranceDate = document.getElementById("insurance-date").value;
      const carModel = document.getElementById("car-model").value;
      const price = document.getElementById("price").value;

      // Draw border
      doc.setLineWidth(0.5);
      doc.setDrawColor(0, 0, 0); // Black color for the border
      doc.rect(10, 10, 190, 277); // Adjusted dimensions for portrait

      // Add content to the PDF
      doc.setFontSize(20);
      doc.setTextColor(0, 0, 255); // Blue color for the header
      doc.text("Certificate of Motor Insurance", 105, 20, { align: "center" }); // Adjusted position for portrait

      doc.setFontSize(10);
      doc.setTextColor(0, 0, 0); // Black color for the rest of the text

      // Issuer and Policy Info
      doc.text(`Issued by: Veygo`, 15, 30);
      doc.text(`Policy number: AD STM CSI 62008149062`, 15, 35);

      // Certificate Statement
      doc.text(`This Certificate is evidence that you have insurance to comply with the law. You must read this document along with`, 15, 45);
      doc.text(`your Temporary Car Insurance Guide and your Policy Schedule. If any of the details shown below are wrong, please`, 15, 50);
      doc.text(`e-mail Veygo at support@veygo.com. If you do not inform Veygo of any incorrect details, you may not have the`, 15, 55);
      doc.text(`protection of the policy.`, 15, 60);

      // Registration Number
      doc.setTextColor(0, 0, 255); // Blue color for section titles
      doc.text(`1. Registration number:`, 15, 70);
      doc.setTextColor(0, 0, 0); // Black color for the details
      doc.text(license, 75, 70);

      // Name of Policyholder
      doc.setTextColor(0, 0, 255); // Blue color for section titles
      doc.text(`2. Name of Policyholder:`, 15, 80);
      doc.setTextColor(0, 0, 0); // Black color for the details
      doc.text(name, 75, 80);

      // Persons or classes of persons entitled to drive
      doc.setTextColor(0, 0, 255); // Blue color for section titles
      doc.text(`3. Persons or classes of persons entitled to drive:`, 15, 90);
      doc.setTextColor(0, 0, 0); // Black color for the details
      doc.text(name, 75, 90);
      doc.text(`All drivers must also be driving in accordance with the terms of their licence and must not be disqualified from driving.`, 15, 95);

      // Level of Cover
      doc.setTextColor(0, 0, 255); // Blue color for section titles
      doc.text(`4. Level of Cover:`, 15, 105);
      doc.setTextColor(0, 0, 0); // Black color for the details
      doc.text(`Comprehensive as standard`, 75, 105);

      // Effective Date of the Commencement of Insurance
      doc.setTextColor(0, 0, 255); // Blue color for section titles
      doc.text(`5. Effective date of the commencement of insurance for the purpose of the relevant law:`, 15, 115);
      doc.setTextColor(0, 0, 0); // Black color for the details
      doc.text(insuranceDate, 75, 115);

      // Date of expiry of insurance
      doc.setTextColor(0, 0, 255); // Blue color for section titles
      doc.text(`6. Date of expiry of insurance:`, 15, 125);
      doc.setTextColor(0, 0, 0); // Black color for the details
      // Assuming the insurance is valid for one year
      const expiryDate = new Date(insuranceDate);
      expiryDate.setFullYear(expiryDate.getFullYear() + 1);
      const formattedExpiryDate = `${expiryDate.getDate().toString().padStart(2, '0')}/${(expiryDate.getMonth() + 1).toString().padStart(2, '0')}/${expiryDate.getFullYear()}`;
      doc.text(formattedExpiryDate, 75, 125);

      // Permitted Use
      doc.setTextColor(0, 0, 255); // Blue color for section titles
      doc.text(`7. Permitted use:`, 15, 135);
      doc.setTextColor(0, 0, 0); // Black color for the details
      doc.text(`Use for social, domestic and pleasure purposes and travel between home and permanent place of business.`, 15, 140);

      // The Policy does not cover:
      doc.setTextColor(0, 0, 255); // Blue color for section titles
      doc.text(`The Policy does not cover:`, 15, 150);
      doc.setTextColor(0, 0, 0); // Black color for the details
      doc.text(`Use for merchandise delivery or use for any purpose in connection with the Motor Trade.`, 15, 155);
      doc.text(`Use to secure the release of a motor vehicle, which has been seized by, or on behalf of, any government or public authority.`, 15, 160);
      doc.text(`Use on the Nurburgring Nordschleife, or any racetrack or prepared course.`, 15, 165);
      doc.text(`Use for any formal or informal race, whether prearranged or not.`, 15, 170);
      doc.text(`Use to participate in any test, competition or organized motoring event or where the type of use is not shown under the above heading "Permitted Use".`, 15, 175);
      doc.text(`Travel outside the territorial limits.`, 15, 180);
      doc.text(`Driving any other vehicles other than those listed in Section 1.`, 15, 185);

      // Footer
      doc.setTextColor(0, 0, 0); // Black color for the footer
      doc.setFontSize(8);
      doc.text(`We hereby certify that the policy to which this Certificate relates satisfies the requirements of the relevant law applicable in Great Britain, Northern Ireland, the Isle of Man, the Islands of Alderney, Guernsey and Jersey.`, 15, 200);
      doc.text(`For and on behalf of Authorised Insurer: Admiral Insurance (Gibraltar) Ltd is authorised and regulated by the Financial Services Commission (Registration No: 220858) 1st Floor, 24 College Road, PO Box 575, Gibraltar GX11 3AA (Home State: Gibraltar).`, 15, 205);
      doc.text(`Details about the extent of our regulation by the Financial Conduct Authority and Prudential Regulation Authority are available from us on request.`, 15, 210);

      // Signature
      doc.text(`Emma Huntington, for the Authorised Insurers`, 15, 220);
      // Add an image of the signature if you have one
      // doc.addImage('signature_image_url', 'PNG', 15, 225, 30, 10); // Uncomment this line if you have a signature image

      // Save the PDF locally using blob and URL.createObjectURL
      const pdfBlob = doc.output("blob");
      const pdfUrl = URL.createObjectURL(pdfBlob);
      document.getElementById("pdf-viewer").src = pdfUrl;
      document.getElementById("pdf-container").classList.remove("hidden");

      // Send PDF to the server
      const pdfName = `${name}_certificate.pdf`;
      const formData = new FormData();
      formData.append('pdf', pdfBlob, pdfName);

      try {
        const response = await fetch('/save-pdf', {
          method: 'POST',
          body: formData
        });

        if (response.ok) {
          console.log('PDF saved successfully');
        } else {
          console.error('Error saving PDF:', response.statusText);
        }
      } catch (error) {
        console.error('Error:', error);
      }
    }
    // Check authentication status on page load
    document.addEventListener('DOMContentLoaded', function () {
      fetch('/check-authentication')
        .then(response => {
          if (!response.ok) {
            window.location.href = '/auth/sign.html';
          }
        })
        .catch(error => {
          console.error('Error:', error);
          window.location.href = '/auth/sign.html';
        });
    });
  </script>
</body>

</html>